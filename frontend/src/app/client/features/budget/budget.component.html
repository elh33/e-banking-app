<div class="budget-container">
  <div class="header">
    <h2>Budget & D√©penses</h2>
    <div class="monthly-selector">
      <button (click)="changeMonth(-1)">&lt;</button>
      <span>{{ currentMonth + 1 }}/{{ currentYear }}</span>
      <button (click)="changeMonth(1)">&gt;</button>
    </div>
  </div>

  <div class="alerts-panel" *ngIf="overages.length > 0">
    <div class="alert" *ngFor="let overage of overages">
      <fa-icon [icon]="faWarning" class="warning-icon"></fa-icon>
      <span>Vous avez d√©pass√© votre budget {{ overage.name }}</span>
    </div>
  </div>

  <!-- Section Cat√©gories et Gestion de cat√©gories c√¥te √† c√¥te -->
  <div class="categories-management-grid">
    <!-- Cat√©gories de budget -->
    <div class="budget-categories panel">
      <h3>Cat√©gories budg√©taires</h3>
      <div class="category-list">
        <div *ngFor="let category of categories" class="category-item">
          <div class="category-header">
            <h4>{{ category.name }}</h4>
            <span>{{ category.currentSpending | currency:'EUR':'symbol':'1.2-2' }} / {{ category.budgetLimit | currency:'EUR':'symbol':'1.2-2' }}</span>
          </div>
          <div class="progress-bar">
            <div class="progress" [style.width.%]="getProgressPercentage(category)"
                 [style.background-color]="category.color"
                 [class.over-budget]="category.currentSpending > category.budgetLimit"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Gestion des cat√©gories -->
    <div class="category-management panel">
      <div class="category-header-actions">
        <h3>G√©rer les cat√©gories</h3>
        <button class="btn-outline" (click)="openCategoryModal()">
          + Nouvelle cat√©gorie
        </button>
      </div>

      <div class="categories-management-list">
        <div *ngFor="let category of categories" class="category-item-management">
          <div class="category-color-indicator" [style.background-color]="category.color"></div>
          <div class="category-details">
            <h4>{{ category.name }}</h4>
            <p>Budget: {{ category.budgetLimit | currency:'EUR':'symbol':'1.2-2' }}</p>
          </div>
          <div class="category-actions">
            <button class="btn-icon" (click)="editCategory(category)" title="Modifier">‚úèÔ∏è</button>
            <button class="btn-icon" (click)="deleteCategory(category.id)" title="Supprimer">üóëÔ∏è</button>
          </div>
        </div>

        <div *ngIf="categories.length === 0" class="empty-state">
          Aucune cat√©gorie d√©finie. Cr√©ez votre premi√®re cat√©gorie.
        </div>
      </div>
    </div>
  </div>

  <!-- Section Graphiques c√¥te √† c√¥te -->
  <div class="charts-container">
    <!-- Graphique en barres des d√©penses -->
    <div class="expense-chart panel">
      <h3>D√©penses mensuelles</h3>
      <canvas *ngIf="isBrowser" baseChart
              [data]="barChartData"
              [options]="barChartOptions"
              [type]="'bar'">
      </canvas>
    </div>

    <!-- Graphique circulaire -->
    <div class="pie-chart panel">
      <h3>R√©partition des d√©penses</h3>
      <canvas *ngIf="isBrowser" baseChart
              [type]="'pie'"
              [data]="pieChartData"
              [options]="pieChartOptions">
      </canvas>
    </div>
  </div>

  <!-- Liste des d√©penses r√©centes -->
  <div class="recent-expenses panel">
    <h3>D√©penses r√©centes</h3>
    <table>
      <thead>
      <tr>
        <th>Date</th>
        <th>Description</th>
        <th>Cat√©gorie</th>
        <th>Montant</th>
      </tr>
      </thead>
      <tbody>
      <tr *ngFor="let expense of expenses.slice(0, 5)">
        <td>{{ expense.date | date:'dd/MM/yyyy' }}</td>
        <td>{{ expense.description }}</td>
        <td>{{ getCategoryName(expense.categoryId) }}</td>
        <td>{{ expense.amount | currency:'EUR':'symbol':'1.2-2' }}</td>
      </tr>
      <tr *ngIf="expenses.length === 0">
        <td colspan="4" class="empty-state">Aucune d√©pense √† afficher</td>
      </tr>
      </tbody>
    </table>
  </div>
</div>

<!-- Bouton flottant pour ajouter une d√©pense -->
<button class="floating-add-button" (click)="openExpenseModal()">+</button>
<!-- Modal pour ajouter/modifier une cat√©gorie -->
<div class="modal-overlay" *ngIf="showCategoryForm" (click)="cancelModal($event, 'category')">
  <div class="modal-content">
    <div class="modal-header">
      <h4>{{ editingCategory ? 'Modifier la cat√©gorie' : 'Nouvelle cat√©gorie' }}</h4>
      <button class="close-modal" (click)="resetCategoryForm()">‚úï</button>
    </div>

    <div class="modal-body">
      <div class="form-group">
        <label for="category-name">Nom</label>
        <input type="text" id="category-name" [(ngModel)]="newCategory.name" required>
      </div>

      <div class="form-group">
        <label>Couleur</label>
        <div class="color-palette">
          <div *ngFor="let color of colorPalette"
               class="color-option"
               [style.background-color]="color"
               [class.selected]="newCategory.color === color"
               (click)="selectColor(color)">
          </div>
        </div>
      </div>

      <div class="form-group">
        <label for="budget-limit">Limite budg√©taire (‚Ç¨)</label>
        <input type="number" id="budget-limit" [(ngModel)]="newCategory.budgetLimit" required min="0">
      </div>
    </div>

    <div class="modal-footer">
      <button class="btn-secondary" (click)="resetCategoryForm()">Annuler</button>
      <button class="btn-primary" (click)="addOrUpdateCategory()"
              [disabled]="!newCategory.name || newCategory.budgetLimit <= 0">
        {{ editingCategory ? 'Mettre √† jour' : 'Ajouter' }}
      </button>
    </div>
  </div>
</div>

<!-- Modal pour ajouter une d√©pense -->
<div class="modal-overlay" *ngIf="showExpenseForm" (click)="cancelModal($event, 'expense')">
  <div class="modal-content">
    <div class="modal-header">
      <h4>Ajouter une d√©pense</h4>
      <button class="close-modal" (click)="resetExpenseForm()">‚úï</button>
    </div>

    <div class="modal-body">
      <div class="form-group">
        <label for="expense-modal-date">Date</label>
        <input type="date" id="expense-modal-date" [(ngModel)]="newExpense.date">
      </div>

      <div class="form-group">
        <label for="expense-modal-amount">Montant</label>
        <input type="number" id="expense-modal-amount" [(ngModel)]="newExpense.amount" step="0.01">
      </div>

      <div class="form-group">
        <label for="expense-modal-description">Description</label>
        <input type="text" id="expense-modal-description" [(ngModel)]="newExpense.description">
      </div>

      <div class="form-group">
        <label for="expense-modal-category">Cat√©gorie</label>
        <select id="expense-modal-category" [(ngModel)]="newExpense.categoryId">
          <option *ngFor="let cat of categories" [value]="cat.id">{{ cat.name }}</option>
        </select>
      </div>

      <div class="form-group">
        <label for="expense-modal-account">Compte</label>
        <select id="expense-modal-account" [(ngModel)]="newExpense.accountId">
          <option *ngFor="let account of accounts" [value]="account.id">{{ account.type }}</option>
        </select>
      </div>
    </div>

    <div class="modal-footer">
      <button class="btn-secondary" (click)="resetExpenseForm()">Annuler</button>
      <button class="btn-primary" (click)="addExpense()">Ajouter</button>
    </div>
  </div>
</div>
